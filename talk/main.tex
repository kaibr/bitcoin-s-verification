\documentclass{beamer}

\usepackage{listings}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage[utf8]{inputenc}


\usecolortheme{beaver}
\addtobeamertemplate{footnote}{}{\vspace{4ex}}
\setbeamerfont{footnote}{size=\scriptsize}

\newcommand\blfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

\AtBeginSection
{
  \begin{frame}
    \frametitle{Table of Contents}
    \tableofcontents[currentsection]
  \end{frame}
}

\setbeamertemplate{itemize items}{\textbullet}
\setbeamertemplate{footline}[text line]{%
  \parbox{\linewidth}{\vspace*{-8pt}
    \insertshorttitle\hfill\insertshortauthor\hfill\insertframenumber
  }
}
\setbeamertemplate{navigation symbols}{}



\graphicspath{{./images/}{../paper/images/}}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}


\lstdefinestyle{scala}{
  language=scala,
  basicstyle=\scriptsize\ttfamily, 
  breaklines=true,
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  numbers=left,
  %frame=single, % Border around box
  %numbersep=-7pt,
  numberstyle=\color{gray},
  stringstyle=\color{mauve}
}

\lstdefinestyle{stainless}{
  numbers=none,
  breaklines=true,
  breakautoindent=true,
  breakindent=63pt,
  basicstyle=\footnotesize\ttfamily
}


\begin{document}

\title{Towards Verifying the Bitcoin-S Library}

\author{Ramon Boss, Kai BrÃ¼nnler, Anna Doukmak}

%\date{2019-06-14}

\frame{\titlepage}


\begin{frame}
  \frametitle{Table of Contents}
  \tableofcontents
\end{frame}


\section{Bitcoin-S}

\begin{frame}[fragile]
  \frametitle{Bitcoin-S}
\begin{lstlisting}[style=scala]
  val privKey = ECPrivateKey.freshPrivateKey
  val creditingSPK = P2PKHScriptPubKey(pubKey = privKey.publicKey)

  val amount = Satoshis(Int64(10000))

  val utxo = TransactionOutput(currencyUnit = amount, scriptPubKey = creditingSPK)

  val tx = BaseTransaction(
    version = Int32.one,
    inputs = List.empty,
    outputs = List(utxo),
    lockTime = UInt32.zero
  )
\end{lstlisting}
\end{frame}




\section{Stainless}


\begin{frame}[fragile]
\frametitle{Stainless: Example}
\begin{lstlisting}[style=scala]
  def factorial(n: Int): Int = {
      require(n >= 0)
      if (n == 0) {
        1
      } else {
        n * factorial(n - 1)
      }
  } ensuring(res => res >= 0)
\end{lstlisting}
\end{frame}



\begin{frame}[fragile]
\frametitle{Stainless: Example}
\begin{block}{Stainless output for the factorial function}
	\centering
		\includegraphics[width=\textwidth]{output1.png}
  \end{block}
\end{frame}

\begin{frame}
\frametitle{Stainless}
\begin{itemize}
  \item Pure Scala
  \item Pre- and Postcondition
  \item Outcome: valid, invalid, unknown
\end{itemize}
\end{frame}


\begin{frame}
\frametitle{Properties}
\begin{itemize}
  \item Bitcoin-S
  \item No-Inflation Property
  \item Addition-with-Zero Property
\end{itemize}
\end{frame}


\section{Rewriting Bitcoin-S for Stainless}



\begin{frame}[fragile]
\frametitle{Inheriting Objects}
This:
\begin{lstlisting}[style=scala]
object Satoshis extends BaseNumbers[Satoshis] {
  val zero = Satoshis(Int64.zero)
  val one = Satoshis(Int64.one)
}
\end{lstlisting}

Becomes this:
\begin{lstlisting}[style=scala]
case object Satoshis extends BaseNumbers[Satoshis] {
  val zero = Satoshis(Int64.zero)
  val one = Satoshis(Int64.one)
}
\end{lstlisting}
\end{frame}


\begin{frame}[fragile]
\frametitle{Abstract Type Members}
This:
\begin{lstlisting}[style=scala]
sealed abstract class CurrencyUnit {
  type A

  protected def underlying: A
}

sealed abstract class Satoshis extends CurrencyUnit {
  override type A = Int64
}
\end{lstlisting}

Becomes this:
\begin{lstlisting}[style=scala]
sealed abstract class CurrencyUnit {
  protected def underlying: Int64
}

sealed abstract class Satoshis extends CurrencyUnit
\end{lstlisting}
\end{frame}


\begin{frame}[fragile]
\frametitle{Missing Bitwise \&-Function on BigInt}
This:
\begin{lstlisting}[style=scala]
sealed abstract class Number {
  def andMask: BigInt
  def checkResult(result: BigInt): BigInt = {
    require((result & andMask) == result)
    result
  }
}  
\end{lstlisting}
Becomes this:
\begin{lstlisting}[style=scala]
sealed abstract class Number {
  // removed redundant checkResult function
}
\end{lstlisting}
\end{frame}


\begin{frame}[fragile]
\frametitle{Formal Specification}
\begin{lstlisting}[style=scala]
def +(c: CurrencyUnit): CurrencyUnit = {
  require(c.satoshis == Satoshis.zero)
  Satoshis(
    satoshis.underlying + c.satoshis.underlying
  )
} ensuring(res => res.satoshis == this.satoshis)
\end{lstlisting}
\end{frame}


\begin{frame}
\frametitle{Output of Stainless}
\centering
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]{assets/final_verify_output.png}
\end{frame}



\section{Bugs We Found}


\begin{frame}
\frametitle{Found Bug in Bitcoin-S}
\includegraphics[width=\textwidth,height=0.8\textheight,keepaspectratio]{assets/bitcoin-s-pr.png}
\end{frame}


\end{document}
